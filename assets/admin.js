import{r as s,l as xe,j as t,c as fe}from"./index2.js";function be(){const[l,j]=s.useState([]),[u,H]=s.useState([]),[O,k]=s.useState(""),[c,V]=s.useState(""),[g,Q]=s.useState(null),[L,X]=s.useState(""),[ee,U]=s.useState(null),[te,R]=s.useState(!1),[B,re]=s.useState({}),[F,P]=s.useState({}),[v,$]=s.useState(""),[se,M]=s.useState([{role:"bot",text:"Hello! Ask me anything about tech trends or search for similar historical tickets."}]),[ie,_]=s.useState(!1),[x,J]=s.useState(!1),[w,ae]=s.useState([]),[S,D]=s.useState([]),[oe,N]=s.useState(!1),[ne,le]=s.useState(""),[A,C]=s.useState(""),[f,de]=s.useState(""),[T,W]=s.useState("all"),[I,Y]=s.useState("id_desc"),z=s.useRef(""),p=s.useRef(null);s.useEffect(()=>{z.current=f},[f]);const q=(e,r)=>{if(r===null||r===""||r==="0")return"None";const a={status_id:{1:"Open",2:"In Progress",3:"Closed"},priority_id:{1:"Low",2:"Medium",3:"High",4:"Urgent"}};if(a[e]&&a[e][r])return a[e][r];if(e==="assigned_to"||e==="claimed_by"){const o=(Array.isArray(u)?u:[]).find(n=>n&&parseInt(n.id)===parseInt(r));return o?o.name:`User ${r}`}return r};s.useEffect(()=>{const e=setTimeout(()=>{de(A)},300);return()=>clearTimeout(e)},[A]),s.useEffect(()=>{E(f)},[f]),s.useEffect(()=>{const e=xe("http://localhost:3001",{path:"/socket.io/",transports:["websocket","polling"],reconnectionAttempts:5});return p.current=e,he(),e.on("connect",()=>{console.log("âœ… Connected to WebSocket Server")}),e.on("refresh_tickets",r=>{r?.ticket_id&&(U(r.ticket_id),setTimeout(()=>U(null),3e3)),E(z.current)}),e.on("summary_ready",({ticketId:r,summary:a})=>{re(i=>({...i,[r]:a})),P(i=>({...i,[r]:!1}))}),e.on("hn_bot_response",r=>{M(a=>[...a,{role:"bot",text:r}]),_(!1)}),e.on("similar_tickets_results",r=>{ae(r),_(!1)}),()=>{e.disconnect(),e.off("refresh_tickets"),e.off("summary_ready"),e.off("hn_bot_response"),e.off("similar_tickets_results")}},[]);const ce=(e,r,a)=>{p.current&&(P(i=>({...i,[e]:!0})),p.current.emit("request_summary",{ticketId:e,filePath:r,description:a}))},K=()=>{if(!v.trim()||!p.current)return;const e=v;M(r=>[...r,{role:"user",text:e}]),_(!0),$(""),e.startsWith("/search ")?p.current.emit("find_similar_tickets",e.replace("/search ","")):p.current.emit("ask_hn_bot",e)};async function h(e,r={}){const a=await fetch(e,{credentials:"include",...r}),i=await a.text();if(!i||i.trim().startsWith("<!DOCTYPE")||i.trim().startsWith("<html"))throw new Error("Server returned HTML (likely Nginx/PHP error).");try{return{res:a,data:JSON.parse(i)}}catch{throw new Error("Invalid server response.")}}async function pe(e){le(e?.title??"Ticket"),D([]);try{const{data:r}=await h(`/api/get_ticket_history.php?ticket_id=${e.id}`);r.success?(D(r.data??[]),N(!0)):alert("Server Error: "+(r.error||"Unknown error"))}catch(r){alert("Fetch failed: "+r.message)}}async function E(e=""){R(!0);try{const r=e?`/api/admin_list_tickets.php?search=${encodeURIComponent(e)}`:"/api/admin_list_tickets.php",{res:a,data:i}=await h(r);if(!a.ok||i.success===!1)throw new Error(i.error||`HTTP ${a.status}`);j(Array.isArray(i.tickets)?i.tickets:[]),i.tier&&V(i.tier),i.current_user_id&&Q(parseInt(i.current_user_id)),i.user_email&&X(i.user_email)}catch(r){k(`Load Error: ${r.message}`)}finally{R(!1)}}async function he(){try{const{data:e}=await h("/api/list_developers.php");e.success&&H(Array.isArray(e.developers)?e.developers:[])}catch{console.error("Could not load developers"),H([])}}async function m(e,r,a){const i=[...l],o=a===""||a===null?null:parseInt(a);j(n=>n.map(d=>d.id===e?{...d,[r]:o}:d));try{const{res:n,data:d}=await h("/api/patch_ticket.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e,[r]:o})});if(!n.ok||d.success===!1)throw new Error(d.error||"Update failed")}catch(n){j(i),k(`Update failed: ${n.message}`)}}async function me(e){if(confirm("Delete this ticket permanently?"))try{const{data:r}=await h("/api/delete_ticket.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e})});if(r.success)E(z.current);else throw new Error(r.error||"Delete failed")}catch(r){k(`Delete failed: ${r.message}`)}}const Z=(Array.isArray(l)?l:[]).filter(e=>T==="all"||String(e.status_id)===T).sort((e,r)=>I==="priority"?(parseInt(r.priority_id)||0)-(parseInt(e.priority_id)||0):I==="assignee"?(e.assigned_to_name||"").localeCompare(r.assigned_to_name||""):parseInt(r.id)-parseInt(e.id)),ue=()=>{C(""),W("all"),Y("id_desc")},b={total:l?.length??0,open:(Array.isArray(l)?l:[]).filter(e=>parseInt(e.status_id)===1).length,urgent:(Array.isArray(l)?l:[]).filter(e=>parseInt(e.priority_id)===4).length,unassigned:(Array.isArray(l)?l:[]).filter(e=>!e.assigned_to&&!e.claimed_by).length},y=Array.isArray(u)?u:[],ge={Senior:y.filter(e=>e&&e.role==="Senior"),Intermediate:y.filter(e=>e&&e.role==="Intermediate"),Junior:y.filter(e=>e&&e.role==="Junior"),Other:y.filter(e=>e&&!["Senior","Intermediate","Junior"].includes(e.role))};return t.jsxs(t.Fragment,{children:[t.jsx("link",{href:"https://fonts.googleapis.com/css2?family=Kumbh+Sans:wght@400;700&display=swap",rel:"stylesheet"}),t.jsx("style",{children:`
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Kumbh Sans', sans-serif; }
        body { background: #141414; color: #fff; }
        .page { max-width: 1200px; margin: 0 auto; padding: 4rem 1rem; }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; }
        .title-group { display: flex; flex-direction: column; gap: 0.5rem; }
        h1 { font-size: 2.5rem; background: linear-gradient(to top, #ff0844, #ffb199); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .tier-badge { display: inline-block; align-self: flex-start; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; background: rgba(255, 255, 255, 0.05); color: #f77062; border: 1px solid #f77062; letter-spacing: 1px; }
        .logout-btn { background: #ff4d4d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; font-weight: bold; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
        .stat-card { background: #1f1f1f; padding: 1.5rem; border-radius: 8px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #fe5196; }
        .toolbar { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; align-items: flex-end; }
        .toolbar-group { display: flex; flex-direction: column; gap: 0.5rem; flex: 1; min-width: 200px; }
        .toolbar-label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: bold; letter-spacing: 0.5px; }
        .search-bar { width: 100%; padding: 14px; background: #1f1f1f; border: 1px solid #333; border-radius: 8px; color: white; font-size: 0.9rem; outline: none; }
        .search-bar:focus { border-color: #fe5196; }
        .reset-btn { padding: 14px; background: rgba(255, 255, 255, 0.05); color: #888; border: 1px dashed #444; border-radius: 8px; font-size: 0.85rem; font-weight: bold; }
        .card { background: #1f1f1f; border-radius: 8px; padding: 2rem; margin-bottom: 2.5rem; }
        .ticket { background: #141414; border-radius: 6px; padding: 1.2rem; margin-bottom: 1rem; border-left: 4px solid #333; transition: all 0.5s ease; }
        .ticket.highlight { border-left-width: 10px; box-shadow: 0 0 20px rgba(254, 81, 150, 0.4); transform: scale(1.02); background: #1a1a1a; }
        .ticket-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }
        .ticket-title { font-weight: 600; background: linear-gradient(to top, #f77062, #fe5196); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .attachment-box { margin-top: 10px; padding: 8px; background: rgba(255, 255, 255, 0.03); border-radius: 4px; border: 1px dashed #444; font-size: 0.85rem; }
        .ai-summary-text { margin-top: 10px; padding: 10px; background: #000; border-left: 3px solid #fe5196; border-radius: 4px; color: #eee; font-style: italic; font-size: 0.8rem; }
        .ai-btn { background: #fe5196; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; float: right; cursor: pointer; }
        .ai-btn:disabled { background: #444; opacity: 0.6; }
        .file-link { color: #3498db; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .assignment-indicator { font-size: 0.8rem; color: #2ecc71; margin-top: 5px; display: block; font-style: italic; }
        .controls-row { display: flex; gap: 10px; margin-top: 1rem; flex-wrap: wrap; align-items: center; }
        select, button { background: #1f1f1f; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 4px; cursor: pointer; }
        .claim-btn { background: #2ecc71; color: #fff; font-weight: bold; border: none; }
        .release-btn { background: #e67e22; color: #fff; font-weight: bold; border: none; }
        .priority-tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; text-transform: uppercase; margin-right: 10px; vertical-align: middle; }
        .danger { color: #ff4d4d; border-color: #442222; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .modal-content { background: #1f1f1f; padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; border: 1px solid #333; }
        .history-item { border-left: 2px solid #fe5196; padding-left: 10px; margin-bottom: 15px; }
        .val-tag { background: #000; padding: 2px 4px; color: #fe5196; font-family: monospace; }

        /* --- NEW BOT STYLES --- */
        .chat-widget { position: fixed; bottom: 20px; right: 20px; width: 350px; background: #1f1f1f; border: 1px solid #333; border-radius: 12px; display: flex; flex-direction: column; z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: all 0.3s ease; }
        .chat-header { padding: 15px; background: linear-gradient(to right, #f77062, #fe5196); color: white; font-weight: bold; border-radius: 11px 11px 0 0; cursor: pointer; display: flex; justify-content: space-between; }
        .chat-body { height: 350px; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; max-width: 85%; line-height: 1.4; }
        .msg-bot { background: #333; color: #eee; align-self: flex-start; border-bottom-left-radius: 0; }
        .msg-user { background: #fe5196; color: white; align-self: flex-end; border-bottom-right-radius: 0; }
        .similar-card { background: #000; border: 1px solid #444; padding: 8px; border-radius: 6px; margin-top: 5px; cursor: pointer; }
        .similar-card:hover { border-color: #fe5196; }
        .chat-footer { padding: 10px; border-top: 1px solid #333; display: flex; gap: 5px; }
        .chat-footer input { flex: 1; background: #141414; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; font-size: 0.8rem; outline: none; }
        .chat-footer input:focus { border-color: #fe5196; }
      `}),t.jsxs("div",{className:"page",children:[t.jsxs("div",{className:"header-flex",children:[t.jsxs("div",{className:"title-group",children:[t.jsx("h1",{children:"IntelliResolver Ops"}),c&&t.jsxs("div",{className:"tier-badge",children:[c," Access Level"]})]}),t.jsx("a",{href:"/logout.php",className:"logout-btn",children:"Logout"})]}),t.jsxs("div",{className:"toolbar",children:[t.jsxs("div",{className:"toolbar-group",style:{flex:2},children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between"},children:[t.jsx("span",{className:"toolbar-label",children:"Search Tickets"}),te&&t.jsx("span",{style:{color:"#fe5196",fontSize:"0.7rem"},children:"Searching..."})]}),t.jsx("input",{type:"text",className:"search-bar",placeholder:"Match against title or content...",value:A,onChange:e=>C(e.target.value)})]}),t.jsxs("div",{className:"toolbar-group",children:[t.jsx("span",{className:"toolbar-label",children:"Filter Status"}),t.jsxs("select",{value:T,onChange:e=>W(e.target.value),style:{padding:"14px"},children:[t.jsx("option",{value:"all",children:"All Tickets"}),t.jsx("option",{value:"1",children:"Open"}),t.jsx("option",{value:"2",children:"In Progress"}),t.jsx("option",{value:"3",children:"Closed"})]})]}),t.jsxs("div",{className:"toolbar-group",children:[t.jsx("span",{className:"toolbar-label",children:"Sort By"}),t.jsxs("select",{value:I,onChange:e=>Y(e.target.value),style:{padding:"14px"},children:[t.jsx("option",{value:"id_desc",children:"Newest First"}),t.jsx("option",{value:"priority",children:"Priority (High to Low)"}),t.jsx("option",{value:"assignee",children:"Assignee (A-Z)"})]})]}),t.jsx("button",{className:"reset-btn",onClick:ue,children:"Clear Filters"})]}),t.jsxs("div",{className:"summary-grid",children:[t.jsxs("div",{className:"stat-card",children:[t.jsx("h3",{children:"Active"}),t.jsx("div",{className:"stat-number",children:b.total})]}),t.jsxs("div",{className:"stat-card",style:{borderTop:"3px solid #e74c3c"},children:[t.jsx("h3",{children:"Urgent"}),t.jsx("div",{className:"stat-number",children:b.urgent})]}),t.jsxs("div",{className:"stat-card",style:{borderTop:"3px solid #f1c40f"},children:[t.jsx("h3",{children:"Unassigned"}),t.jsx("div",{className:"stat-number",children:b.unassigned})]}),t.jsxs("div",{className:"stat-card",style:{borderTop:"3px solid #2ecc71"},children:[t.jsx("h3",{children:"Open"}),t.jsx("div",{className:"stat-number",children:b.open})]})]}),O&&t.jsx("div",{style:{color:"#ff4d4d",marginBottom:"1rem"},children:O}),t.jsx("div",{className:"card",children:Z.length===0?t.jsx("div",{style:{textAlign:"center",padding:"2rem",color:"#666"},children:"No tickets found matching these filters."}):Z.map(e=>{const r=ee===parseInt(e.id),a=!e.claimed_by&&(e.assigned_to===null||parseInt(e.assigned_to)===g)&&L!=="admin@intelliresolvers.com",i=parseInt(e.claimed_by)===g;return t.jsxs("div",{className:`ticket ${r?"highlight":""}`,style:{borderLeftColor:e.priority_color},children:[t.jsxs("div",{className:"ticket-header",children:[t.jsxs("div",{children:[t.jsx("span",{className:"priority-tag",style:{background:e.priority_color},children:e.priority_label}),t.jsxs("span",{className:"ticket-title",children:["#",e.id," â€” ",e.title]}),e.claimed_by_name?t.jsxs("span",{className:"assignment-indicator",children:["âœ“ Claimed by: ",e.claimed_by_name," ",parseInt(e.claimed_by)===g?"(You)":""]}):e.assigned_to_name?t.jsxs("span",{className:"assignment-indicator",style:{color:"#3498db"},children:["â„¹ Assigned to: ",e.assigned_to_name]}):null]}),t.jsx("div",{style:{color:"#888",fontSize:"0.8rem"},children:e.email})]}),t.jsxs("div",{style:{margin:"1rem 0",color:"#ccc",lineHeight:"1.6"},children:[t.jsx("button",{className:"ai-btn",onClick:()=>ce(e.id,e.file_path,e.message),disabled:F[e.id],children:F[e.id]?"ANALYZING...":"âœ¨ AI SUMMARIZE"}),e.message]}),B[e.id]&&t.jsxs("div",{className:"ai-summary-text",style:{marginBottom:"10px"},children:[t.jsx("strong",{children:"AI Summary:"})," ",B[e.id]]}),e.file_path&&t.jsxs("div",{className:"attachment-box",style:{marginBottom:"10px"},children:[t.jsx("strong",{children:"ðŸ“Ž Attachment:"}),t.jsx("a",{href:`/${e.file_path}`,target:"_blank",rel:"noopener noreferrer",className:"file-link",children:"View uploaded file"})]}),t.jsxs("div",{className:"controls-row",children:[a&&t.jsx("button",{className:"claim-btn",onClick:()=>m(e.id,"claimed_by",g),children:"Claim Ticket"}),i&&t.jsx("button",{className:"release-btn",onClick:()=>m(e.id,"claimed_by",""),children:"Release Ticket"}),t.jsxs("select",{value:e.assigned_to||"",onChange:o=>m(e.id,"assigned_to",o.target.value),disabled:c==="Junior"||c==="Intermediate",children:[t.jsx("option",{value:"",children:"Unassigned"}),Object.entries(ge).map(([o,n])=>n.length>0&&t.jsx("optgroup",{label:`${o} Tier`,children:n.map(d=>t.jsx("option",{value:d.id,children:d.name},d.id))},o))]}),t.jsxs("select",{value:e.status_id,onChange:o=>m(e.id,"status_id",o.target.value),disabled:L==="admin@intelliresolvers.com",children:[t.jsx("option",{value:"1",children:"Open"}),t.jsx("option",{value:"2",children:"In Progress"}),t.jsx("option",{value:"3",children:"Closed"})]}),t.jsxs("select",{value:e.priority_id,onChange:o=>m(e.id,"priority_id",o.target.value),disabled:c==="Junior"||c==="Intermediate",children:[t.jsx("option",{value:"1",children:"Low"}),t.jsx("option",{value:"2",children:"Medium"}),t.jsx("option",{value:"3",children:"High"}),t.jsx("option",{value:"4",children:"Urgent"})]}),t.jsx("button",{onClick:()=>pe(e),children:"ðŸ“œ History"}),t.jsx("button",{className:"danger",onClick:()=>me(e.id),disabled:c==="Junior"||c==="Intermediate",children:"Archive"})]})]},e.id)})})]}),oe&&t.jsx("div",{className:"modal-overlay",onClick:()=>N(!1),children:t.jsxs("div",{className:"modal-content",onClick:e=>e.stopPropagation(),children:[t.jsxs("h3",{children:["History: ",ne]}),t.jsx("div",{style:{marginTop:"20px"},children:!S||S.length===0?t.jsx("p",{children:"No changes recorded yet."}):S.map(e=>t.jsxs("div",{className:"history-item",children:[t.jsx("div",{style:{fontSize:"0.7rem",color:"#777"},children:e.changed_at}),t.jsxs("div",{children:[t.jsx("strong",{children:e.changed_by})," changed ",e.field_changed.replace("_id","")]}),t.jsxs("div",{style:{fontSize:"0.8rem"},children:[t.jsx("span",{className:"val-tag",children:q(e.field_changed,e.old_value)})," â†’ ",t.jsx("span",{className:"val-tag",children:q(e.field_changed,e.new_value)})]})]},e.id))}),t.jsx("button",{style:{marginTop:"20px",width:"100%",padding:"10px"},onClick:()=>N(!1),children:"Close"})]})}),t.jsxs("div",{className:"chat-widget",style:{transform:x?"translateY(0)":"translateY(calc(100% - 50px))"},children:[t.jsxs("div",{className:"chat-header",onClick:()=>J(!x),children:[t.jsx("span",{children:"ðŸ¤– Gemini 2.0 Assistant"}),t.jsx("span",{children:x?"â–¼":"â–²"})]}),x&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"chat-body",children:[se.map((e,r)=>t.jsx("div",{className:`chat-msg ${e.role==="bot"?"msg-bot":"msg-user"}`,children:e.text},r)),w.length>0&&t.jsxs("div",{className:"chat-msg msg-bot",children:[t.jsxs("strong",{children:["Found ",w.length," similar cases:"]}),w.map((e,r)=>t.jsxs("div",{className:"similar-card",onClick:()=>{C(`#${e.ticket_id}`),J(!1)},children:[t.jsxs("div",{style:{fontSize:"0.7rem",color:"#fe5196"},children:["ID: #",e.ticket_id," | Match: ",(e.similarity_score*100).toFixed(0),"%"]}),t.jsx("div",{style:{fontSize:"0.8rem",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:e.summary||e.content})]},r))]}),ie&&t.jsx("div",{className:"chat-msg msg-bot",style:{opacity:.5},children:"Processing AI..."})]}),t.jsxs("div",{className:"chat-footer",children:[t.jsx("input",{type:"text",placeholder:"Ask tech or type /search [query]...",value:v,onChange:e=>$(e.target.value),onKeyDown:e=>e.key==="Enter"&&K()}),t.jsx("button",{onClick:K,style:{background:"#fe5196",border:"none",padding:"5px 10px",borderRadius:"4px",fontWeight:"bold"},children:"Send"})]})]})]})]})}const G=document.getElementById("root");G&&fe.createRoot(G).render(t.jsx(be,{}));
